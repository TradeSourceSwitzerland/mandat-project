<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zevix - Leads</title>
    <style>
        .lead-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .lead-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .stats {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Zevix - Lead Management</h1>
    
    <div class="stats">
        <p>E-Mail: <span id="userEmail">-</span></p>
        <p>Plan: <span id="userPlan">-</span></p>
        <p>Leads verwendet: <span id="leadsUsed">0</span> / <span id="leadsLimit">0</span></p>
        <p>Verbleibend: <span id="leadsRemaining">0</span></p>
    </div>
    
    <div>
        <button id="selectAllBtn">Alle ausw√§hlen</button>
        <button id="deselectAllBtn">Auswahl aufheben</button>
        <button id="exportCSVBtn">CSV Export (Ausgew√§hlte)</button>
        <button id="exportPDFBtn">PDF Export (Ausgew√§hlte)</button>
        <a href="/dashboard">Zum Dashboard</a>
    </div>
    
    <div id="leadsList">
        <!-- Sample leads for demonstration -->
        <div class="lead-item" data-lead-id="lead-001">
            <strong>Max Mustermann</strong> - max.mustermann@example.com
        </div>
        <div class="lead-item" data-lead-id="lead-002">
            <strong>Anna Schmidt</strong> - anna.schmidt@example.com
        </div>
        <div class="lead-item" data-lead-id="lead-003">
            <strong>Peter M√ºller</strong> - peter.mueller@example.com
        </div>
    </div>

    <script>
        // ‚úÖ FIX 1: Use absolute API URL
        const API = "https://mandat-backend.onrender.com";
        
        let selectedLeads = new Set();
        let currentMonth = "";
        let currentUsed = 0;
        let currentLimit = 0;
        
        // Initialize page
        async function initPage() {
            const token = localStorage.getItem("auth_token");
            
            if (!token) {
                alert("üîê Du musst eingeloggt sein, um Leads zu exportieren");
                window.location.href = "/login";
                return;
            }
            
            // ‚úÖ FIX 5: Load usage data from backend on page load
            try {
                const response = await fetch(API + "/zevix/refresh-token", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: "include",
                    body: JSON.stringify({ token })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update localStorage with fresh data
                    localStorage.setItem("auth_token", data.token);
                    localStorage.setItem("auth_until", data.valid_until);
                    localStorage.setItem("plan", data.plan);
                    localStorage.setItem("zevix_email", data.email);
                    
                    currentMonth = data.month;
                    currentUsed = data.used || 0;
                    
                    // ‚úÖ FIX 6: Keep localStorage synchronized
                    localStorage.setItem(`zevix_leads_used_${currentMonth}`, currentUsed);
                    
                    // Calculate limit based on plan
                    const limits = {
                        "none": 0,
                        "basic": 500,
                        "business": 1000,
                        "enterprise": 4500
                    };
                    currentLimit = limits[data.plan] || 0;
                    
                    // Update UI
                    document.getElementById("userEmail").textContent = data.email;
                    document.getElementById("userPlan").textContent = data.plan;
                    updateUsageDisplay();
                } else {
                    alert("‚ùå Fehler beim Laden der Nutzungsdaten");
                    window.location.href = "/login";
                }
            } catch (error) {
                console.error("Init error:", error);
                alert("‚ùå Fehler beim Initialisieren der Seite");
            }
        }
        
        function updateUsageDisplay() {
            const remaining = Math.max(0, currentLimit - currentUsed);
            document.getElementById("leadsUsed").textContent = currentUsed;
            document.getElementById("leadsLimit").textContent = currentLimit;
            document.getElementById("leadsRemaining").textContent = remaining;
        }
        
        // Handle lead selection
        document.getElementById("leadsList").addEventListener("click", function(e) {
            const leadItem = e.target.closest(".lead-item");
            if (leadItem) {
                const leadId = leadItem.dataset.leadId;
                if (selectedLeads.has(leadId)) {
                    selectedLeads.delete(leadId);
                    leadItem.classList.remove("selected");
                } else {
                    selectedLeads.add(leadId);
                    leadItem.classList.add("selected");
                }
            }
        });
        
        // Select all leads
        document.getElementById("selectAllBtn").addEventListener("click", function() {
            selectedLeads.clear();
            document.querySelectorAll(".lead-item").forEach(item => {
                const leadId = item.dataset.leadId;
                selectedLeads.add(leadId);
                item.classList.add("selected");
            });
        });
        
        // Deselect all leads
        document.getElementById("deselectAllBtn").addEventListener("click", function() {
            selectedLeads.clear();
            document.querySelectorAll(".lead-item").forEach(item => {
                item.classList.remove("selected");
            });
        });
        
        // ‚úÖ FIX 2 & 3: Use batch endpoint and send all lead IDs
        async function consumeLeadsViaAPI(leadIds) {
            const token = localStorage.getItem("auth_token");
            
            if (!token) {
                alert("üîê Du musst eingeloggt sein, um Leads zu exportieren");
                return false;
            }
            
            try {
                const response = await fetch(API + "/zevix/export-leads-batch", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    credentials: "include",
                    body: JSON.stringify({ lead_ids: leadIds })
                });
                
                // ‚úÖ FIX 7: Check HTTP status before parsing JSON
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } catch (e) {
                        // If JSON parsing fails, use status text
                        errorMessage = response.statusText || errorMessage;
                    }
                    
                    // Provide specific error messages based on status code
                    if (response.status === 401) {
                        alert("üîê Sitzung abgelaufen. Bitte melde dich erneut an.");
                        window.location.href = "/login";
                    } else if (response.status === 403) {
                        alert(`üö´ Zugriff verweigert: ${errorMessage}`);
                    } else if (response.status === 500) {
                        alert(`‚ö†Ô∏è Server-Fehler: ${errorMessage}\n\nBitte versuche es sp√§ter erneut.`);
                    } else {
                        alert(`‚ùå Fehler beim Lead-Export: ${errorMessage}`);
                    }
                    return false;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    currentUsed = data.used;
                    
                    // ‚úÖ FIX 6: Update localStorage with new usage
                    localStorage.setItem(`zevix_leads_used_${currentMonth}`, currentUsed);
                    
                    updateUsageDisplay();
                    
                    // Build message with multiple parts
                    const messageParts = [data.message];
                    
                    if (data.duplicate_ids && data.duplicate_ids.length > 0) {
                        messageParts.push(`‚ö†Ô∏è ${data.duplicate_ids.length} Lead(s) bereits exportiert (√ºbersprungen)`);
                    }
                    if (data.not_exported && data.not_exported.length > 0) {
                        messageParts.push(`‚ö†Ô∏è ${data.not_exported.length} Lead(s) nicht exportiert (Limit erreicht)`);
                    }
                    
                    alert(messageParts.join('\n'));
                    return true;
                } else {
                    alert("‚ùå Export fehlgeschlagen: " + (data.message || data.error));
                    return false;
                }
            } catch (error) {
                console.error("Export error:", error);
                // ‚úÖ FIX 8: Show detailed error message with better context
                const errorDetails = error.message || error.toString() || 'Unknown error';
                // Check for network-related errors more robustly
                const errorStr = typeof errorDetails === 'string' ? errorDetails.toLowerCase() : '';
                const isNetworkError = error instanceof TypeError || 
                                     errorStr.includes('network') ||
                                     errorStr.includes('failed to fetch');
                
                if (isNetworkError) {
                    alert("üåê Netzwerkfehler: Bitte √ºberpr√ºfe deine Internetverbindung und versuche es erneut.");
                } else {
                    alert(`‚ùå Fehler beim Export: ${errorDetails}`);
                }
                return false;
            }
        }
        
        // Export CSV
        document.getElementById("exportCSVBtn").addEventListener("click", async function() {
            if (selectedLeads.size === 0) {
                alert("‚ö†Ô∏è Bitte w√§hle mindestens einen Lead aus");
                return;
            }
            
            const leadIds = Array.from(selectedLeads);
            const success = await consumeLeadsViaAPI(leadIds);
            
            if (success) {
                // Generate CSV
                let csv = "Name,Email\n";
                leadIds.forEach(leadId => {
                    const leadItem = document.querySelector(`[data-lead-id="${leadId}"]`);
                    if (leadItem) {
                        const text = leadItem.textContent.trim();
                        csv += text + "\n";
                    }
                });
                
                // Download CSV
                const blob = new Blob([csv], { type: "text/csv" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `leads-${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        });
        
        // ‚úÖ FIX 4: PDF Export with tracking
        document.getElementById("exportPDFBtn").addEventListener("click", async function() {
            if (selectedLeads.size === 0) {
                alert("‚ö†Ô∏è Bitte w√§hle mindestens einen Lead aus");
                return;
            }
            
            const leadIds = Array.from(selectedLeads);
            
            // First, track the leads via API
            const success = await consumeLeadsViaAPI(leadIds);
            
            if (success) {
                alert("‚úÖ PDF-Export erfolgreich verbucht!\n\n‚ö†Ô∏è Hinweis: Die PDF-Generierung ist derzeit im Frontend noch nicht implementiert. Die Leads wurden aber korrekt von deinem Kontingent abgezogen.\n\nBitte verwende vorerst den CSV-Export.");
            }
        });
        
        // Initialize page on load
        initPage();
    </script>
</body>
</html>